name: Docker é•œåƒåŒæ­¥å™¨

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTC 18:00ï¼‰
  schedule:
    - cron: '0 18 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # ä»£ç æ¨é€è§¦å‘
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: é•œåƒåŒæ­¥
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤ 0ï¼šåœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰ç«‹å³æ¸…ç†ç£ç›˜
    - name: âš¡ ç«‹å³æ¸…ç†ç£ç›˜ç©ºé—´ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      run: |
        echo "================================================================"
        echo "ğŸ”¥ ç´§æ€¥ç£ç›˜ç©ºé—´æ¸…ç†å¼€å§‹"
        echo "================================================================"
        
        # 1. æ˜¾ç¤ºå½“å‰ç£ç›˜çŠ¶æ€
        echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -h
        echo ""
        
        # 2. ç«‹å³æ¸…ç† GitHub Actions Runner æ—¥å¿—ï¼ˆé”™è¯¯æ ¹æºï¼‰
        echo "æ¸…ç† GitHub Actions Runner æ—¥å¿—æ–‡ä»¶..."
        sudo rm -rf /home/runner/actions-runner/_diag/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/_work/*/.git/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/_work/*/node_modules 2>/dev/null || true
        
        # 3. å¼ºåˆ¶åœæ­¢å¹¶æ¸…ç† Dockerï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "åœæ­¢å¹¶æ¸…ç† Docker..."
        sudo systemctl stop docker 2>/dev/null || true
        sudo systemctl stop docker.socket 2>/dev/null || true
        sudo systemctl stop containerd 2>/dev/null || true
        
        # åˆ é™¤ Docker æ•°æ®ç›®å½•
        sudo rm -rf /var/lib/docker/* 2>/dev/null || true
        sudo rm -rf /var/lib/containerd/* 2>/dev/null || true
        
        # 4. æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
        echo "æ¸…ç†ç³»ç»Ÿç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶..."
        sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
        sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/.npm/* 2>/dev/null || true
        sudo rm -rf /home/runner/.m2/* 2>/dev/null || true
        sudo rm -rf /home/runner/.gradle/* 2>/dev/null || true
        
        # 5. æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼ˆéå¸¸æ¿€è¿›ï¼‰
        echo "æ¸…ç†ç³»ç»Ÿæ—¥å¿—..."
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
        sudo journalctl --vacuum-time=1s 2>/dev/null || true
        sudo rm -rf /var/log/journal/* 2>/dev/null || true
        
        # 6. æ¸…ç† apt ç¼“å­˜
        echo "æ¸…ç† apt ç¼“å­˜..."
        sudo apt-get clean 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
        
        # 7. æŸ¥æ‰¾å¹¶åˆ é™¤å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰
        echo "æŸ¥æ‰¾å¹¶åˆ é™¤å¤§æ–‡ä»¶..."
        sudo find /home/runner -type f -size +10M -delete 2>/dev/null || true
        sudo find /tmp -type f -size +1M -delete 2>/dev/null || true
        
        # 8. é‡Šæ”¾å†…å­˜å’Œäº¤æ¢åˆ†åŒº
        echo "é‡Šæ”¾å†…å­˜å’Œäº¤æ¢ç©ºé—´..."
        sudo swapoff -a 2>/dev/null || true
        sudo swapon -a 2>/dev/null || true
        
        # 9. é‡Šæ”¾é¡µé¢ç¼“å­˜ã€ç›®å½•é¡¹å’Œinode
        echo "é‡Šæ”¾ç³»ç»Ÿç¼“å­˜..."
        sudo sync
        sudo sh -c 'echo 1 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        sudo sh -c 'echo 2 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        
        # 10. æ˜¾ç¤ºæ¸…ç†åçš„çŠ¶æ€
        echo ""
        echo "æ¸…ç†å®Œæˆåçš„ç£ç›˜çŠ¶æ€ï¼š"
        df -h
        echo "================================================================"
        echo "âœ… ç´§æ€¥ç£ç›˜æ¸…ç†å®Œæˆ"
        echo "================================================================"

    # æ­¥éª¤ 1ï¼šæœ€å¤§åŒ–æ„å»ºç©ºé—´ï¼ˆä½¿ç”¨æ›´æ¿€è¿›çš„é…ç½®ï¼‰
    - name: ğŸ“¦ æœ€å¤§åŒ–æ„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 256     # åªä¿ç•™ 256MB
        swap-size-mb: 4096       # 4GB äº¤æ¢ç©ºé—´
        remove-dotnet: 'true'
        remove-haskell: 'true'
        remove-android: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        remove-python: 'true'
        remove-node: 'true'
        remove-java: 'true'
        remove-ruby: 'true'
        remove-go: 'true'
        remove-php: 'true'
        remove-rust: 'true'
        build-mount-path: '/var/lib/docker/'

    # æ­¥éª¤ 2ï¼šé‡æ–°å¯åŠ¨ Docker æœåŠ¡
    - name: ğŸ³ å¯åŠ¨ Docker æœåŠ¡
      run: |
        echo "å¯åŠ¨ Docker æœåŠ¡..."
        sudo systemctl start docker
        sudo systemctl start containerd
        sleep 5
        
        # éªŒè¯ Docker çŠ¶æ€
        echo "Docker ç‰ˆæœ¬ï¼š"
        docker --version
        echo ""
        echo "Docker ç³»ç»ŸçŠ¶æ€ï¼š"
        docker system df
        
        # å†æ¬¡æ¸…ç† Dockerï¼ˆç¡®ä¿å¹²å‡€ï¼‰
        docker system prune -a -f --volumes 2>/dev/null || true

    # æ­¥éª¤ 3ï¼šæ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # åªæ£€å‡ºæœ€æ–°æäº¤ï¼Œå‡å°‘ç£ç›˜ä½¿ç”¨
        fetch-depth: 1

    # æ­¥éª¤ 4ï¼šç®€åŒ–çš„é•œåƒå¤„ç†æ–¹æ¡ˆï¼ˆé€è¡Œå¤„ç†ï¼ŒåŠæ—¶æ¸…ç†ï¼‰
    - name: ğŸš€ å¤„ç†é•œåƒåˆ—è¡¨
      run: |
        echo "================================================================"
        echo "å¼€å§‹å¤„ç†é•œåƒåˆ—è¡¨"
        echo "================================================================"
        
        # ç™»å½•åˆ°é˜¿é‡Œäº‘
        echo "ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
        echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
        
        # æ£€æŸ¥é•œåƒåˆ—è¡¨æ–‡ä»¶
        if [ ! -f "images.txt" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° images.txt æ–‡ä»¶"
          exit 1
        fi
        
        # æ¸…ç†é•œåƒåˆ—è¡¨æ–‡ä»¶ï¼ˆç§»é™¤ç©ºè¡Œå’Œæ³¨é‡Šï¼‰
        echo "é¢„å¤„ç†é•œåƒåˆ—è¡¨..."
        grep -v '^\s*#' images.txt | grep -v '^\s*$' > images_clean.txt
        total_images=$(wc -l < images_clean.txt)
        echo "éœ€è¦å¤„ç† $total_images ä¸ªé•œåƒ"
        
        # æ˜¾ç¤ºåˆå§‹ç£ç›˜çŠ¶æ€
        echo ""
        echo "å¤„ç†å‰çš„ç£ç›˜çŠ¶æ€ï¼š"
        df -h
        
        # é€è¡Œå¤„ç†é•œåƒ
        success_count=0
        fail_count=0
        line_number=0
        
        while IFS= read -r image_line || [ -n "$image_line" ]; do
          line_number=$((line_number + 1))
          
          echo ""
          echo "================================================================"
          echo "[$line_number/$total_images] å¤„ç†é•œåƒ: $image_line"
          echo "================================================================"
          
          # å¤„ç†å‰çš„ç£ç›˜æ£€æŸ¥
          echo "å¤„ç†å‰çš„ç£ç›˜çŠ¶æ€ï¼š"
          df -h | head -3
          
          # æå–é•œåƒåç§°ï¼ˆç§»é™¤å‚æ•°ï¼‰
          image_name=$(echo "$image_line" | awk '{print $NF}')
          echo "é•œåƒåç§°: $image_name"
          
          # å°è¯•æ‹‰å–é•œåƒï¼ˆæœ€å¤šé‡è¯•2æ¬¡ï¼‰
          max_retries=2
          retry_count=0
          pull_success=false
          
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "å°è¯•æ‹‰å–é•œåƒ (å°è¯• $retry_count/$max_retries)..."
            
            if docker pull "$image_line" 2>&1 | tee /tmp/docker_pull.log; then
              pull_success=true
              break
            else
              echo "æ‹‰å–å¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..."
              
              # æ¸…ç† Docker ç¼“å­˜
              docker system prune -f 2>/dev/null || true
              sudo rm -rf /tmp/* 2>/dev/null || true
              
              # ç­‰å¾…åå†é‡è¯•
              sleep 3
            fi
          done
          
          if [ "$pull_success" = false ]; then
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥: $image_line"
            fail_count=$((fail_count + 1))
            continue
          fi
          
          echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
          
          # æ„å»ºç›®æ ‡é•œåƒåç§°
          # ç§»é™¤å¯èƒ½çš„ @sha256:... éƒ¨åˆ†
          clean_image="${image_name%%@*}"
          # æå–é•œåƒæ ‡ç­¾
          image_tag=$(basename "$clean_image")
          target_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_tag"
          
          echo "ç›®æ ‡é•œåƒ: $target_image"
          
          # æ‰“æ ‡ç­¾
          if docker tag "$clean_image" "$target_image"; then
            echo "âœ… é•œåƒæ ‡ç­¾è®¾ç½®æˆåŠŸ"
          else
            echo "âŒ é•œåƒæ ‡ç­¾è®¾ç½®å¤±è´¥"
            fail_count=$((fail_count + 1))
            continue
          fi
          
          # æ¨é€é•œåƒ
          echo "æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘..."
          if docker push "$target_image"; then
            echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
            success_count=$((success_count + 1))
          else
            echo "âŒ é•œåƒæ¨é€å¤±è´¥"
            fail_count=$((fail_count + 1))
          fi
          
          # âš¡ ç«‹å³æ¸…ç†é•œåƒä»¥é‡Šæ”¾ç©ºé—´
          echo "æ¸…ç†æœ¬åœ°é•œåƒ..."
          docker rmi -f "$clean_image" "$target_image" 2>/dev/null || true
          
          # æ¯å¤„ç†3ä¸ªé•œåƒå°±æ·±åº¦æ¸…ç†ä¸€æ¬¡
          if [ $((line_number % 3)) -eq 0 ]; then
            echo ""
            echo "--- å®šæœŸæ·±åº¦æ¸…ç† ---"
            docker system prune -a -f 2>/dev/null || true
            docker builder prune -a -f 2>/dev/null || true
            sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
            echo "å®šæœŸæ¸…ç†å®Œæˆ"
          fi
          
          # æ˜¾ç¤ºå½“å‰ç£ç›˜çŠ¶æ€
          echo ""
          echo "å½“å‰ç£ç›˜çŠ¶æ€ï¼š"
          df -h | head -3
          
        done < images_clean.txt
        
        # æœ€ç»ˆç»Ÿè®¡
        echo ""
        echo "================================================================"
        echo "å¤„ç†å®Œæˆç»Ÿè®¡"
        echo "================================================================"
        echo "æ€»é•œåƒæ•°: $total_images"
        echo "æˆåŠŸ: $success_count"
        echo "å¤±è´¥: $fail_count"
        echo "================================================================"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f images_clean.txt
        
        # å¦‚æœæ‰€æœ‰é•œåƒéƒ½å¤±è´¥ï¼Œåˆ™å·¥ä½œæµå¤±è´¥
        if [ $success_count -eq 0 ] && [ $total_images -gt 0 ]; then
          echo "âŒ æ‰€æœ‰é•œåƒå¤„ç†å¤±è´¥"
          exit 1
        fi

    # æ­¥éª¤ 5ï¼šæœ€ç»ˆæ¸…ç†ï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰
    - name: ğŸ§¹ æœ€ç»ˆæ¸…ç†
      if: always()
      run: |
        echo "================================================================"
        echo "æ‰§è¡Œæœ€ç»ˆæ¸…ç†"
        echo "================================================================"
        
        # åœæ­¢æ‰€æœ‰ Docker å®¹å™¨
        docker stop $(docker ps -q) 2>/dev/null || true
        
        # åˆ é™¤æ‰€æœ‰ Docker èµ„æº
        docker system prune -a -f --volumes 2>/dev/null || true
        docker builder prune -a -f 2>/dev/null || true
        docker container prune -f 2>/dev/null || true
        docker volume prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
        sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
        
        # æ¸…ç† GitHub Actions æ—¥å¿—
        sudo rm -rf /home/runner/actions-runner/_diag/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
        
        # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
        echo ""
        echo "æœ€ç»ˆç£ç›˜çŠ¶æ€ï¼š"
        df -h
        
        echo ""
        echo "================================================================"
        echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "================================================================"
