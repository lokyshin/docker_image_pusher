name: Docker 镜像同步器

on:
  # 定时任务：每天北京时间凌晨2点执行
  # 注意：GitHub Actions 使用 UTC 时间，所以是 UTC 18:00
  schedule:
    - cron: '0 18 * * *'
  
  # 支持手动触发工作流
  workflow_dispatch:
  
  # 当代码推送到 main 分支时触发
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  # 构建和推送镜像任务
  build:
    name: 拉取并推送镜像
    runs-on: ubuntu-latest
    
    steps:
    # 第一步：在开始任何操作之前清理磁盘空间
    - name: 紧急磁盘空间清理
      run: |
        echo "=============================================================================="
        echo "开始紧急磁盘空间清理..."
        echo "=============================================================================="
        
        # 显示初始磁盘状态
        echo "初始磁盘状态："
        df -h
        echo ""
        
        # 1. 清理 GitHub Runner 日志文件（这是错误的关键原因）
        echo "1. 清理 GitHub Actions Runner 日志文件..."
        sudo rm -rf /home/runner/actions-runner/_diag/*.log 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/cached/_diag/*.log 2>/dev/null || true
        sudo find /home/runner -name "*.log" -type f -delete 2>/dev/null || true
        
        # 2. 清理系统日志
        echo "2. 清理系统日志文件..."
        sudo journalctl --vacuum-time=1s 2>/dev/null || true
        sudo rm -rf /var/log/*.gz /var/log/*.1 /var/log/*.old 2>/dev/null || true
        
        # 3. 清理 Docker 资源
        echo "3. 清理 Docker 资源..."
        # 停止所有容器
        docker stop $(docker ps -q) 2>/dev/null || echo "没有正在运行的容器"
        # 删除所有容器
        docker rm -f $(docker ps -aq) 2>/dev/null || echo "没有可删除的容器"
        # 删除所有镜像
        docker rmi -f $(docker images -q) 2>/dev/null || echo "没有可删除的镜像"
        # 删除所有卷
        docker volume rm $(docker volume ls -q) 2>/dev/null || echo "没有可删除的卷"
        # 清理所有 Docker 系统资源
        docker system prune -a -f --volumes 2>/dev/null || echo "Docker 清理完成"
        
        # 4. 清理缓存和临时文件
        echo "4. 清理缓存和临时文件..."
        sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
        sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
        sudo rm -rf /var/cache/* 2>/dev/null || true
        sudo apt-get clean 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
        
        # 5. 清理大文件（查找并删除大于 100MB 的文件）
        echo "5. 查找并清理大文件..."
        sudo find /home/runner -type f -size +100M -delete 2>/dev/null || true
        
        # 6. 释放系统缓存
        echo "6. 释放系统缓存..."
        sudo sync
        sudo sh -c 'echo 1 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        sudo sh -c 'echo 2 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null || true
        
        # 显示清理后的磁盘状态
        echo ""
        echo "紧急清理完成后的磁盘状态："
        df -h
        echo "=============================================================================="
    
    # 第二步：最大化构建空间
    - name: 最大化构建空间
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512  # 只保留 512MB
        swap-size-mb: 2048    # 增加交换空间到 2GB
        remove-dotnet: 'true'
        remove-haskell: 'true'
        remove-android: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        remove-python: 'true'
        remove-node: 'true'
        remove-java: 'true'
        remove-ruby: 'true'
        remove-go: 'true'
        build-mount-path: '/var/lib/docker/'
    
    # 第三步：重启 Docker 服务
    - name: 重启 Docker 服务
      run: |
        echo "重启 Docker 服务..."
        sudo systemctl stop docker 2>/dev/null || true
        sudo systemctl start docker
        sleep 3
        echo "Docker 服务重启完成"
        
        # 验证 Docker 状态
        docker --version
        docker system df || echo "Docker 磁盘信息获取失败"
    
    # 第四步：检出代码
    - name: 检出代码
      uses: actions/checkout@v4
    
    # 第五步：设置 Docker Buildx
    - name: 设置 Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # 第六步：处理镜像列表（分批处理，避免磁盘空间不足）
    - name: 处理 Docker 镜像
      run: |
        echo "=============================================================================="
        echo "开始处理 Docker 镜像..."
        echo "=============================================================================="
        
        # 登录到阿里云容器镜像服务
        echo "登录到阿里云容器镜像服务..."
        docker login -u "$ALIYUN_REGISTRY_USER" -p "$ALIYUN_REGISTRY_PASSWORD" "$ALIYUN_REGISTRY"
        
        # 检查 images.txt 文件是否存在
        if [ ! -f "images.txt" ]; then
          echo "错误：找不到 images.txt 文件"
          exit 1
        fi
        
        # 显示当前磁盘状态
        echo "处理前的磁盘状态："
        df -h
        
        # 备份原始文件
        cp images.txt images_backup.txt
        
        # 移除空行和注释行
        sed -i '/^\s*$/d' images.txt
        sed -i '/^\s*#/d' images.txt
        
        # 计算镜像数量
        total_images=$(wc -l < images.txt)
        echo "总共需要处理 $total_images 个镜像"
        
        # 如果镜像太多，分批处理（每批5个）
        if [ "$total_images" -gt 20 ]; then
          echo "镜像数量较多，启用分批处理模式..."
          batch_size=5
        else
          batch_size=$total_images
        fi
        
        # 分割文件
        split -l $batch_size images.txt batch_
        
        # 处理计数器
        batch_counter=0
        success_counter=0
        fail_counter=0
        failed_images=()
        
        # 处理每个批次
        for batch_file in batch_*; do
          batch_counter=$((batch_counter + 1))
          echo ""
          echo "=============================================================================="
          echo "处理第 $batch_counter 批镜像（文件: $batch_file）"
          echo "=============================================================================="
          
          # 批次开始前的磁盘清理
          echo "批次开始前的磁盘清理..."
          docker system prune -f 2>/dev/null || true
          sudo rm -rf /tmp/* 2>/dev/null || true
          
          # 显示磁盘状态
          echo "当前磁盘状态："
          df -h
          
          # 处理批次中的每个镜像
          image_counter=0
          while IFS= read -r image_line || [ -n "$image_line" ]; do
            image_counter=$((image_counter + 1))
            echo ""
            echo "--- 处理第 $image_counter 个镜像：$image_line ---"
            
            # 拉取镜像
            echo "正在拉取镜像..."
            if docker pull $image_line; then
              echo "✓ 镜像拉取成功"
              
              # 获取镜像信息
              image_full=$(echo "$image_line" | awk '{print $NF}')
              image_clean="${image_full%%@*}"
              image_name_tag=$(echo "$image_clean" | awk -F'/' '{print $NF}')
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              # 构建新的镜像标签
              new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name_tag"
              
              # 打标签
              echo "打标签: $image_clean -> $new_image"
              docker tag "$image_clean" "$new_image"
              
              # 推送镜像
              echo "推送镜像到阿里云..."
              if docker push "$new_image"; then
                echo "✓ 镜像推送成功"
                success_counter=$((success_counter + 1))
              else
                echo "✗ 镜像推送失败"
                fail_counter=$((fail_counter + 1))
                failed_images+=("$image_line")
              fi
              
              # 立即删除本地镜像以释放空间
              echo "清理本地镜像..."
              docker rmi -f "$image_clean" "$new_image" 2>/dev/null || true
              
            else
              echo "✗ 镜像拉取失败"
              fail_counter=$((fail_counter + 1))
              failed_images+=("$image_line")
              
              # 尝试清理后重试一次
              echo "尝试清理后重试..."
              docker system prune -f 2>/dev/null || true
              sleep 2
              
              if docker pull $image_line; then
                echo "✓ 重试拉取成功"
                
                # 继续后续处理...
                image_name_tag=$(echo "$image_line" | awk -F'/' '{print $NF}')
                new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name_tag"
                docker tag "$image_line" "$new_image"
                
                if docker push "$new_image"; then
                  echo "✓ 镜像推送成功"
                  success_counter=$((success_counter + 1))
                else
                  echo "✗ 镜像推送失败"
                  fail_counter=$((fail_counter + 1))
                fi
                
                docker rmi -f "$image_line" "$new_image" 2>/dev/null || true
              fi
            fi
            
            # 每个镜像处理后都检查磁盘空间
            echo "当前磁盘状态："
            df -h | head -n 2
            
          done < "$batch_file"
          
          # 批次结束后的深度清理
          echo ""
          echo "批次结束后的深度清理..."
          docker system prune -a -f 2>/dev/null || true
          docker builder prune -a -f 2>/dev/null || true
          docker volume prune -f 2>/dev/null || true
          
          # 清理临时文件
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          
          # 删除已处理的批次文件
          rm "$batch_file"
          
        done
        
        # 恢复原始文件
        mv images_backup.txt images.txt
        
        # 最终统计
        echo ""
        echo "=============================================================================="
        echo "镜像处理完成统计："
        echo "=============================================================================="
        echo "总镜像数: $total_images"
        echo "成功处理: $success_counter"
        echo "处理失败: $fail_counter"
        
        if [ ${#failed_images[@]} -gt 0 ]; then
          echo ""
          echo "失败的镜像列表："
          for failed in "${failed_images[@]}"; do
            echo "  - $failed"
          done
        fi
        
        echo ""
        echo "最终磁盘状态："
        df -h
    
    # 第七步：最终清理（无论成功与否都执行）
    - name: 最终清理
      if: always()
      run: |
        echo "=============================================================================="
        echo "执行最终清理..."
        echo "=============================================================================="
        
        # 深度清理 Docker
        docker system prune -a -f --volumes 2>/dev/null || true
        docker builder prune -a -f 2>/dev/null || true
        docker container prune -f 2>/dev/null || true
        docker volume prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true
        
        # 清理系统文件
        sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/_diag/* 2>/dev/null || true
        sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
        
        # 清理日志文件
        sudo find /home/runner -name "*.log" -type f -delete 2>/dev/null || true
        
        # 显示最终状态
        echo "最终磁盘状态："
        df -h
        
        echo "Docker 系统状态："
        docker system df 2>/dev/null || echo "无法获取 Docker 状态"
        
        echo ""
        echo "=============================================================================="
        echo "工作流执行完成！"
        echo "=============================================================================="
