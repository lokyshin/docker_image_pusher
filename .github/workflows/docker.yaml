name: Docker é•œåƒåŒæ­¥å™¨

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTC 18:00ï¼‰
  schedule:
    - cron: '0 18 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  # ============================================
  # ä»»åŠ¡1ï¼šç¯å¢ƒæ¸…ç†ï¼ˆå§‹ç»ˆç¬¬ä¸€ä¸ªè¿è¡Œï¼‰
  # ============================================
  cleanup:
    name: ğŸ§¹ ç¯å¢ƒæ¸…ç†
    runs-on: ubuntu-latest
    
    steps:
      - name: âš¡ æ·±åº¦æ¸…ç† Runner ç¯å¢ƒ
        run: |
          echo "================================================================"
          echo "å¼€å§‹æ·±åº¦æ¸…ç† GitHub Actions ç¯å¢ƒ"
          echo "================================================================"
          
          # æ˜¾ç¤ºæ¸…ç†å‰çŠ¶æ€
          echo "æ¸…ç†å‰ç£ç›˜çŠ¶æ€ï¼š"
          df -h | head -5
          echo ""
          
          # 1. æ¸…ç†è¯Šæ–­æ—¥å¿—ç›®å½•ï¼ˆå…³é”®ï¼šé˜²æ­¢æ—¥å¿—ç´¯ç§¯å¯¼è‡´ç©ºé—´ä¸è¶³ï¼‰
          echo "1. æ¸…ç†è¯Šæ–­æ—¥å¿—..."
          sudo rm -rf /home/runner/actions-runner/_diag/* 2>/dev/null || true
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          sudo find /home/runner -name "*.log" -type f -delete 2>/dev/null || true
          
          # 2. æ¸…ç†å·¥ä½œç›®å½•
          echo "2. æ¸…ç†å·¥ä½œç›®å½•..."
          sudo rm -rf /home/runner/actions-runner/_work/* 2>/dev/null || true
          
          # 3. æ¸…ç†ç³»ç»Ÿç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
          echo "3. æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶..."
          sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
          sudo rm -rf /home/runner/.npm/* 2>/dev/null || true
          sudo rm -rf /home/runner/.m2/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          
          # 4. åœæ­¢å¹¶æ¸…ç† Docker
          echo "4. æ¸…ç† Docker..."
          docker stop $(docker ps -q) 2>/dev/null || true
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          docker rmi -f $(docker images -q) 2>/dev/null || true
          docker system prune -a -f --volumes 2>/dev/null || true
          docker volume prune -f 2>/dev/null || true
          
          # 5. é‡Šæ”¾ç³»ç»Ÿç¼“å­˜
          echo "5. é‡Šæ”¾ç³»ç»Ÿç¼“å­˜..."
          sudo sync
          sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null || true
          
          # æ˜¾ç¤ºæ¸…ç†åçŠ¶æ€
          echo ""
          echo "æ¸…ç†åç£ç›˜çŠ¶æ€ï¼š"
          df -h | head -5
          echo "================================================================"
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
          echo "================================================================"

  # ============================================
  # ä»»åŠ¡2ï¼šæœ€å¤§åŒ–æ„å»ºç©ºé—´ï¼ˆä¾èµ–æ¸…ç†å®Œæˆï¼‰
  # ============================================
  maximize-space:
    name: ğŸ“¦ æœ€å¤§åŒ–æ„å»ºç©ºé—´
    runs-on: ubuntu-latest
    needs: cleanup  # ç­‰å¾… cleanup å®Œæˆ
    
    steps:
      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-python: 'true'
          remove-node: 'true'
          remove-java: 'true'
          remove-ruby: 'true'
          remove-go: 'true'
          remove-php: 'true'
          remove-rust: 'true'

  # ============================================
  # ä»»åŠ¡3ï¼šå¤„ç†é•œåƒï¼ˆä¾èµ–ç©ºé—´æœ€å¤§åŒ–å®Œæˆï¼‰
  # ============================================
  process-images:
    name: ğŸš€ å¤„ç† Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: maximize-space  # ç­‰å¾… maximize-space å®Œæˆ
    
    steps:
      # å¯åŠ¨ Docker
      - name: ğŸ³ å¯åŠ¨ Docker
        run: |
          sudo systemctl start docker
          sleep 3
          docker --version

      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # å¤„ç†é•œåƒ
      - name: å¤„ç†é•œåƒåˆ—è¡¨
        run: |
          echo "================================================================"
          echo "å¼€å§‹å¤„ç† Docker é•œåƒ"
          echo "================================================================"
          
          # ç™»å½•é˜¿é‡Œäº‘
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
          
          # æ£€æŸ¥é•œåƒåˆ—è¡¨
          if [ ! -f "images.txt" ]; then
            echo "âŒ æ‰¾ä¸åˆ° images.txt æ–‡ä»¶"
            exit 1
          fi
          
          # é¢„å¤„ç†ï¼šç§»é™¤ç©ºè¡Œå’Œæ³¨é‡Š
          grep -v '^\s*#' images.txt | grep -v '^\s*$' > images_clean.txt
          total=$(wc -l < images_clean.txt)
          echo "å…± $total ä¸ªé•œåƒéœ€è¦å¤„ç†"
          echo ""
          
          # é€è¡Œå¤„ç†
          success=0
          failed=0
          count=0
          
          while IFS= read -r image_line; do
            count=$((count + 1))
            
            echo "----------------------------------------------------------------"
            echo "[$count/$total] å¤„ç†: $image_line"
            
            # æ‹‰å–é•œåƒ
            if docker pull "$image_line"; then
              # æ„å»ºç›®æ ‡é•œåƒå
              clean_image="${image_line%%@*}"
              tag=$(basename "$clean_image")
              target="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$tag"
              
              # æ‰“æ ‡ç­¾
              docker tag "$clean_image" "$target"
              
              # æ¨é€
              if docker push "$target"; then
                echo "âœ… æˆåŠŸ: $tag"
                success=$((success + 1))
              else
                echo "âŒ æ¨é€å¤±è´¥: $tag"
                failed=$((failed + 1))
              fi
              
              # ç«‹å³æ¸…ç†
              docker rmi -f "$clean_image" "$target" 2>/dev/null || true
              
            else
              echo "âŒ æ‹‰å–å¤±è´¥: $image_line"
              failed=$((failed + 1))
            fi
            
            # æ¯3ä¸ªé•œåƒæ·±åº¦æ¸…ç†ä¸€æ¬¡
            if [ $((count % 3)) -eq 0 ]; then
              echo "--- å®šæœŸæ¸…ç† ---"
              docker system prune -f 2>/dev/null || true
              docker builder prune -f 2>/dev/null || true
            fi
            
          done < images_clean.txt
          
          # æœ€ç»ˆç»Ÿè®¡
          echo ""
          echo "================================================================"
          echo "å¤„ç†å®Œæˆ: æˆåŠŸ $success, å¤±è´¥ $failed, æ€»è®¡ $total"
          echo "================================================================"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f images_clean.txt
          
          # å¦‚æœå…¨éƒ¨å¤±è´¥ï¼Œæ ‡è®°å·¥ä½œæµå¤±è´¥
          [ $success -eq 0 ] && [ $total -gt 0 ] && exit 1 || true

      # æœ€ç»ˆæ¸…ç†
      - name: ğŸ§¹ æœ€ç»ˆæ¸…ç†
        if: always()
        run: |
          echo "æ‰§è¡Œæœ€ç»ˆæ¸…ç†..."
          docker stop $(docker ps -q) 2>/dev/null || true
          docker system prune -a -f --volumes 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo rm -rf /home/runner/actions-runner/_diag/* 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"
