name: Docker 镜像同步 - 第1批

on:
  schedule:
    - cron: '0 18 * * *'  # 每天凌晨2点
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: 处理第1批镜像（1-5个）
      run: |
        # 只取前5行
        head -n 5 images.txt > images_batch.txt
        
        # 登录并处理这5个镜像
        echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
        
        while read line; do
          docker pull "$line"
          # ... 推送逻辑 ...
          docker rmi -f "$line"
          docker system prune -f
        done < images_batch.txt
